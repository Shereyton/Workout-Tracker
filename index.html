<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Workout Tracker Pro</title>
  <meta name="description" content="Lightweight mobile workout tracker with export + AI summary">
  <style>
    :root {
      --grad-main: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --grad-accent: linear-gradient(135deg,#f093fb 0%,#f5576c 100%);
      --grad-success: linear-gradient(135deg,#11998e 0%,#38ef7d 100%);
      --grad-header: linear-gradient(135deg,#2c3e50,#34495e);
      --danger: #dc3545;
      --radius: 20px;
      --transition: 0.25s cubic-bezier(.4, .0, .2, 1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--grad-main);
      min-height: 100vh;
      color: #222;
      transition: background .4s, color .3s;
    }
    body.dark { background: #181a1f; color: #f5f6fa; }
    .container {
      max-width: 520px; margin: 0 auto;
      background: #fff; border-radius: var(--radius);
      box-shadow: 0 12px 32px -8px rgba(0,0,0,.25);
      overflow: hidden;
      animation: fadeIn .4s;
    }
    body.dark .container { background: #262a33; }
    @keyframes fadeIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }

    .header { text-align: center; background: var(--grad-header); padding: 20px; color: #fff; }
    .header h1 { font-size: 24px; }
    .date { font-size: 13px; opacity: .8; }

    .section { padding: 20px; }
    select, input[type=number], input[type=text] {
      width: 100%; padding: 12px; margin-bottom: 12px;
      border: 2px solid #e1e8ed; border-radius: 12px;
      font-size: 16px; background: #fff;
      transition: border-color .3s;
    }
    body.dark select, body.dark input { background: #1e2127; border-color: #39414d; color: #f5f6fa; }
    select:focus, input:focus { outline: none; border-color: #667eea; }

    .inline-row { display: flex; gap: 10px; }
    .inline-row .field { flex: 1; }

    .current-exercise {
      background: var(--grad-accent); color: #fff; padding: 16px;
      border-radius: 12px; text-align: center; margin-bottom: 16px;
    }
    .current-exercise h2 { font-size: 20px; }
    .current-exercise .set-info { font-size: 14px; opacity: .9; }

    .btn { width:100%; padding: 15px; border:none; border-radius: 12px;
      font-size:16px; font-weight:600; cursor: pointer; margin-bottom:10px;
      transition: transform .1s;
    }
    .btn:active { transform: scale(.97); }
    .btn-primary { background: var(--grad-main); color: #fff; }
    .btn-secondary { background: #f0f3f6; color: #555; }
    .btn-reset { background: #6c757d; color: #fff; }
    .btn-export { background: var(--grad-success); color: #fff; }

    .sets-history { margin-top: 20px; }
    .set-item {
      background: #f8f9fa; border: 1px solid #e5e9ef;
      padding: 10px; border-radius: 8px; margin-bottom: 8px;
      display: flex; justify-content: space-between; align-items: center;
    }
    body.dark .set-item { background: #20242a; border-color: #2c323a; }
    .set-label { font-weight: 600; }
    .set-meta { opacity: .8; }
    .set-actions { display:flex; gap:6px; }

    .btn-mini { padding: 4px 8px; font-size:12px; border-radius:6px; cursor:pointer; }
    .btn-mini.edit { background: #ffc107; }
    .btn-mini.del { background: var(--danger); color: #fff; }

    .edit-form { background: #e3f2fd; padding:10px; border-radius:8px; margin-top:8px; }
    .edit-form .row { display:flex; gap:8px; margin-bottom:8px; }
    .edit-form input { flex:1; padding:6px; }
    .edit-form .row2 { display:flex; gap:6px; }

    .rest-timer {
      background: linear-gradient(135deg,#ff9a9e 0%,#fecfef 100%);
      color: #2c3e50; padding: 15px; border-radius: 12px;
      text-align: center; margin-bottom: 16px; cursor: pointer;
    }
    .timer-display { font-size: 24px; font-weight: bold; }

    .summary { background: #f8f9fa; padding: 15px; border-radius: 12px; }
    body.dark .summary { background: #20242a; }

    #darkToggle {
      position: fixed; bottom: 20px; right: 20px; padding: 12px;
      background: rgba(255,255,255,.9); border:none; border-radius: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸ’ª Workout Tracker Pro</h1>
      <div id="today" class="date"></div>
    </div>

    <div class="section">
      <div class="inline-row" style="margin-bottom:12px;">
        <input type="text" id="customExercise" placeholder="Add Custom Exercise"
          class="field">
        <button id="addExercise" class="btn btn-secondary" style="flex:0 0 120px;">Add</button>
      </div>

      <select id="exerciseSelect">
        <option value="">Select Exercise</option>
        <option>Bench Press</option>
        <option>Incline Bench Press</option>
        <option>Squats</option>
        <option>Straight Arm Bicep Curls</option>
        <option>Lat Pulldown (Underhand)</option>
        <option>Lat Pulldown (Overhand)</option>
      </select>

      <div id="interface" class="hidden">
        <div class="current-exercise">
          <h2 id="exerciseName"></h2>
          <div class="set-info">Set <span id="setCounter">1</span></div>
        </div>

        <div class="inline-row" style="margin-bottom:8px;">
          <label style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="useTimer" checked> Use rest timer
          </label>
          <input type="number" id="restSecsInput" class="field"
            placeholder="Rest (sec)" value="90" min="5">
        </div>

        <div id="restBox" class="rest-timer hidden">
          <div>Rest Time</div>
          <div id="restDisplay" class="timer-display">01:30</div>
          <small>Tap to cancel</small>
        </div>

        <div class="inline-row">
          <input type="number" id="weight" class="field" placeholder="Weight (lbs)">
          <input type="number" id="reps" class="field" placeholder="Reps">
        </div>

        <button id="logBtn" class="btn btn-primary">Log Set</button>
        <button id="nextExerciseBtn" class="btn btn-secondary">Next Exercise</button>
        <button id="resetBtn" class="btn btn-reset">Reset Workout</button>
      </div>

      <div class="sets-history">
        <h3>Today's Sets</h3>
        <div id="setsList"></div>
      </div>

      <div class="summary">
        <h3>Workout Summary</h3>
        <div id="summaryText">Start your first exercise to begin tracking.</div>
      </div>

      <button id="exportBtn" class="btn btn-export">Export (JSON + AI + CSV)</button>
    </div>
  </div>

  <button id="darkToggle" aria-label="Toggle dark mode">ðŸŒ“</button>

  <script>
    // --- State ---
    let session = JSON.parse(localStorage.getItem('wt_session')) || {exercises:[],startedAt:null};
    let currentExercise = JSON.parse(localStorage.getItem('wt_currentExercise')) || null;
    let restTimer = null, restStartMs = 0, restSetIndex = null;

    // --- Elements ---
    const todayEl = document.getElementById('today');
    const darkToggle = document.getElementById('darkToggle');
    const customExerciseInput = document.getElementById('customExercise');
    const addExerciseBtn = document.getElementById('addExercise');
    const exerciseSelect = document.getElementById('exerciseSelect');
    const interfaceBox = document.getElementById('interface');
    const exerciseNameEl = document.getElementById('exerciseName');
    const setCounterEl = document.getElementById('setCounter');
    const useTimerEl = document.getElementById('useTimer');
    const restSecsInput = document.getElementById('restSecsInput');
    const restBox = document.getElementById('restBox');
    const restDisplay = document.getElementById('restDisplay');
    const weightInput = document.getElementById('weight');
    const repsInput = document.getElementById('reps');
    const logBtn = document.getElementById('logBtn');
    const nextExerciseBtn = document.getElementById('nextExerciseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const setsList = document.getElementById('setsList');
    const summaryText = document.getElementById('summaryText');
    const exportBtn = document.getElementById('exportBtn');

    // --- Init ---
    todayEl.textContent = new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    if(currentExercise){ showInterface(); rebuildSetsList(); updateSetCounter(); }

    // --- Dark Mode ---
    darkToggle.addEventListener('click', ()=> {
      document.body.classList.toggle('dark');
      localStorage.setItem('wt_theme', document.body.classList.contains('dark')?'dark':'light');
    });
    if(localStorage.getItem('wt_theme')==='dark') document.body.classList.add('dark');

    // --- Add Custom Exercise ---
    addExerciseBtn.addEventListener('click', ()=> {
      const n = customExerciseInput.value.trim();
      if(!n) return;
      const opt = document.createElement('option'); opt.textContent = n;
      exerciseSelect.append(opt);
      exerciseSelect.value = n;
      customExerciseInput.value=''; startExercise(n);
    });

    // --- Select Exercise ---
    exerciseSelect.addEventListener('change', e => { if(e.target.value) startExercise(e.target.value); });
    function startExercise(name){
      if(!session.startedAt) session.startedAt = new Date().toISOString();
      if(currentExercise && currentExercise.sets.length) pushOrMergeExercise(currentExercise);
      currentExercise = { name, sets:[], nextSet:1 };
      saveState(); showInterface(); rebuildSetsList(); updateSetCounter(); weightInput.focus();
    }
    function showInterface(){ interfaceBox.classList.remove('hidden'); exerciseNameEl.textContent=currentExercise.name; }

    // --- Log Set ---
    logBtn.addEventListener('click', ()=> {
      const w = parseInt(weightInput.value), r = parseInt(repsInput.value);
      if(!w||!r){ alert('Enter weight & reps'); return; }
      const useT = useTimerEl.checked, p = parseInt(restSecsInput.value)||0;
      const setObj = { set:currentExercise.nextSet, weight:w, reps:r,
                       time:new Date().toLocaleTimeString(), restPlanned:useT?p:null, restActual:null };
      currentExercise.sets.push(setObj);
      addSetElement(setObj,currentExercise.sets.length-1);
      currentExercise.nextSet++; updateSetCounter();
      weightInput.select(); repsInput.value=''; repsInput.focus();
      if(useT) startRest(p, currentExercise.sets.length-1);
      updateSummary(); saveState();
    });
    function addSetElement(s,i){
      const item = document.createElement('div'); item.className='set-item'; item.dataset.index=i;
      const restInfo = s.restActual!=null ? ` â€¢ Rest: ${s.restActual}s` : (s.restPlanned?` â€¢ Rest planned: ${s.restPlanned}s`:'');
      item.innerHTML = `<div><div class="set-label">${s.set}. ${s.weight}Ã—${s.reps}</div><div class="set-meta">${s.time}${restInfo}</div></div>` +
                       `<div class="set-actions">` +
                       `<button class="btn-mini edit" data-action="edit">Edit</button>` +
                       `<button class="btn-mini del" data-action="del">Del</button></div>`;
      setsList.append(item);
    }

    // --- Edit/Delete ---
    setsList.addEventListener('click', e => {
      const btn = e.target.closest('button'); if(!btn) return;
      const action=btn.dataset.action, idx=parseInt(btn.closest('.set-item').dataset.index);
      if(action==='del') deleteSet(idx); else openEditForm(btn.closest('.set-item'), idx);
    });
    function deleteSet(idx){ if(confirm('Delete this set?')){ currentExercise.sets.splice(idx,1); renumberSets(); rebuildSetsList(); updateSummary(); saveState(); }}
    function openEditForm(item, idx){
      if(item.querySelector('.edit-form')) return;
      const s = currentExercise.sets[idx];
      const form = document.createElement('div'); form.className='edit-form';
      form.innerHTML =
      `<div class="row"><input type="number" class="editW" value="${s.weight}" min="0">
