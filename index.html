<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Workout Tracker Pro</title>
  <meta name="description" content="Lightweight mobile workout tracker with export + AI summary">
  <style>
    /* Simplified: include your full CSS here */
    :root { --grad-main: linear-gradient(135deg,#667eea 0%,#764ba2 100%); /* ...other vars...*/ }
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:var(--grad-main); }
    /* ...rest of styles unchanged from your working version...*/
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸ’ª Workout Tracker Pro</h1>
      <div id="today" class="date"></div>
    </div>

    <div class="section">
      <!-- Add Custom Exercise -->
      <div class="inline-row" style="margin-bottom:6px;">
        <input type="text" id="customExercise" placeholder="Add Custom Exercise">
        <button id="addExercise" class="btn btn-secondary" style="flex:0 0 120px;">Add</button>
      </div>

      <!-- Exercise Select -->
      <select id="exerciseSelect">
        <option value="">Select Exercise</option>
        <option>Bench Press</option>
        <option>Incline Bench Press</option>
        <option>Squats</option>
        <option>Straight Arm Bicep Curls</option>
        <option>Lat Pulldown (Underhand)</option>
        <option>Lat Pulldown (Overhand)</option>
      </select>

      <!-- Workout Interface -->
      <div id="interface" class="hidden">
        <div class="current-exercise">
          <h2 id="exerciseName"></h2>
          <div class="set-info">Set <span id="setCounter">1</span></div>
        </div>

        <!-- Timer Controls -->
        <div class="inline-row" style="margin-bottom:8px;">
          <label style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="useTimer" checked> Use rest timer
          </label>
          <input type="number" id="restSecsInput" class="field" placeholder="Rest (sec)" value="90" min="5">
        </div>

        <!-- Rest Timer Display -->
        <div id="restBox" class="rest-timer hidden">
          <div>Rest Time</div>
          <div id="restDisplay" class="timer-display">01:30</div>
          <small>Tap to cancel</small>
        </div>

        <!-- Inputs -->
        <div class="inline-row">
          <input type="number" id="weight" class="field" placeholder="Weight (lbs)">
          <input type="number" id="reps" class="field" placeholder="Reps">
        </div>

        <!-- Action Buttons -->
        <button id="logBtn" class="btn btn-primary">Log Set</button>
        <button id="nextExerciseBtn" class="btn btn-secondary">Next Exercise</button>
        <button id="resetBtn" class="btn btn-reset">Reset Workout</button>
      </div>

      <!-- Sets History -->
      <div class="sets-history">
        <h3>Today's Sets</h3>
        <div id="setsList"></div>
      </div>

      <!-- Summary & Export -->
      <div class="summary">
        <h3>Workout Summary</h3>
        <div id="summaryText">Start your first exercise to begin tracking.</div>
      </div>
      <button id="exportBtn" class="btn btn-export">Export (JSON + CSV + AI)</button>
    </div>
  </div>

  <!-- Dark Mode Toggle -->
  <button id="darkToggle" aria-label="Toggle dark mode" class="dark-toggle">ðŸŒ“</button>

  <script>
    // --- State ---
    let session = JSON.parse(localStorage.getItem('wt_session')) || { exercises: [], startedAt: null };
    let currentExercise = JSON.parse(localStorage.getItem('wt_currentExercise')) || null;
    let restTimer = null, restStartMs = 0, restSetIndex = -1;

    // --- Elements ---
    const todayEl = document.getElementById('today');
    const addExerciseBtn = document.getElementById('addExercise');
    const customExerciseInput = document.getElementById('customExercise');
    const exerciseSelect = document.getElementById('exerciseSelect');
    const interfaceBox = document.getElementById('interface');
    const exerciseNameEl = document.getElementById('exerciseName');
    const setCounterEl = document.getElementById('setCounter');
    const useTimerEl = document.getElementById('useTimer');
    const restSecsInput = document.getElementById('restSecsInput');
    const restBox = document.getElementById('restBox');
    const restDisplay = document.getElementById('restDisplay');
    const weightInput = document.getElementById('weight');
    const repsInput = document.getElementById('reps');
    const logBtn = document.getElementById('logBtn');
    const nextExerciseBtn = document.getElementById('nextExerciseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const setsList = document.getElementById('setsList');
    const summaryText = document.getElementById('summaryText');
    const exportBtn = document.getElementById('exportBtn');
    const darkToggle = document.getElementById('darkToggle');

    // --- Init ---
    todayEl.textContent = new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    if (currentExercise) { showInterface(); rebuildSetsList(); updateSetCounter(); }
    updateSummary();
    if (localStorage.getItem('wt_theme') === 'dark') document.body.classList.add('dark');

    // --- Dark Mode ---
    darkToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      localStorage.setItem('wt_theme', document.body.classList.contains('dark')?'dark':'light');
    });

    // --- Add Custom Exercise ---
    addExerciseBtn.addEventListener('click', () => {
      const name = customExerciseInput.value.trim(); if(!name) return;
      const opt = document.createElement('option'); opt.textContent = name;
      exerciseSelect.append(opt); exerciseSelect.value = name;
      customExerciseInput.value = '';
      startExercise(name);
    });

    // --- Select Exercise ---
    exerciseSelect.addEventListener('change', e => { if(e.target.value) startExercise(e.target.value); });
    function startExercise(name) {
      if (!session.startedAt) session.startedAt = new Date().toISOString();
      if (currentExercise && currentExercise.sets.length) pushOrMergeExercise(currentExercise);
      currentExercise = { name, sets: [], nextSet: 1 };
      saveState(); showInterface(); rebuildSetsList(); updateSetCounter(); weightInput.focus();
    }
    function showInterface(){ interfaceBox.classList.remove('hidden'); exerciseNameEl.textContent = currentExercise.name; }

    // --- Log Set ---
    logBtn.addEventListener('click', () => {
      const w = parseInt(weightInput.value,10), r = parseInt(repsInput.value,10);
      if (!w||!r){ alert('Enter weight & reps'); return; }
      const useT = useTimerEl.checked, planned = parseInt(restSecsInput.value,10)||0;
      const setObj = { set:currentExercise.nextSet, weight:w, reps:r,
                       time:new Date().toLocaleTimeString(), restPlanned:useT?planned:null, restActual:null };
      currentExercise.sets.push(setObj); addSetElement(setObj, currentExercise.sets.length-1);
      currentExercise.nextSet++; updateSetCounter(); weightInput.select(); repsInput.value='';
      if(useT) startRest(planned, currentExercise.sets.length-1);
      updateSummary(); saveState();
    });
    function addSetElement(s,idx){
      const item=document.createElement('div'); item.className='set-item'; item.dataset.index=idx;
      const restInfo = s.restActual!=null?` â€¢ Rest: ${s.restActual}s`:(s.restPlanned?` â€¢ Rest planned: ${s.restPlanned}s`:'');
      item.innerHTML = `<div><div class="set-label">Set ${s.set}: ${s.weight}Ã—${s.reps}</div><div class="set-meta">${s.time}${restInfo}</div></div><div class="set-actions"><button class="btn-mini edit" data-action="edit">Edit</button><button class="btn-mini del" data-action="del">Del</button></div>`;
      setsList.append(item);
    }

    // --- Edit/Delete ---
    setsList.addEventListener('click', e => {
      const btn = e.target.closest('button'); if(!btn) return;
      const action = btn.dataset.action, idx = parseInt(btn.closest('.set-item').dataset.index,10);
      if(action==='del') deleteSet(idx); else openEditForm(btn.closest('.set-item'), idx);
    });
    function deleteSet(idx){ if(confirm('Delete this set?')){ currentExercise.sets.splice(idx,1); renumberSets(); rebuildSetsList(); updateSummary(); saveState(); }}

    // --- Edit Form ---
    function openEditForm(item, idx){
      if(item.querySelector('.edit-form')) return;
      const s = currentExercise.sets[idx];
      const form = document.createElement('div'); form.className='edit-form';
      form.innerHTML = `
        <div class="row">
          <input type="number" class="editW" value="${s.weight}" min="0">
          <input type="number" class="editR" value="${s.reps}"   min="1">
        </div>
        <div class="row">
          <input type="number" class="editRestPlanned" value="${s.restPlanned||''}" placeholder="Rest planned(sec)">
          <input type="number" class="editRestActual"  value="${s.restActual ||''}" placeholder="Rest actual(sec)">
        </div>
        <div class="row2">
          <button type="button" class="btn-mini edit" data-edit-save>Save</button>
          <button type="button" class="btn-mini del"  data-edit-cancel>Cancel</button>
        </div>
      `;
      item.append(form);
      form.addEventListener('click', ev => {
        if(ev.target.hasAttribute('data-edit-save')){
          const nw = parseInt(form.querySelector('.editW').value,10);
          const nr = parseInt(form.querySelector('.editR').value,10);
          const vp = form.querySelector('.editRestPlanned').value;
          const va = form.querySelector('.editRestActual').value;
          if(isNaN(nw)||isNaN(nr)){ alert('Enter valid weight & reps'); return; }
          s.weight = nw; s.reps = nr;
          s.restPlanned = vp?parseInt(vp,10):null;
          s.restActual  = va?parseInt(va,10):null;
          saveState(); rebuildSetsList(); updateSummary(); form.remove();
        }
        if(ev.target.hasAttribute('data-edit-cancel')){
          form.remove();
        }
      });
    }

    function renumberSets(){
      currentExercise.sets.forEach((s,i)=>s.set=i+1);
      currentExercise.nextSet = currentExercise.sets.length+1;
    }

    function updateSetCounter(){ setCounterEl.textContent = currentExercise.nextSet; }

    // --- Rest Timer ---
    function startRest(sec, idx){ stopRest(); restStartMs = Date.now(); restSetIndex = idx;
      let rem = sec; restBox.classList.remove('hidden'); restDisplay.textContent = `${rem}s`;
      restTimer = setInterval(()=>{
        rem--; restDisplay.textContent = `${rem}s`;
        if(rem <= 0){ finishRest(); restBox.classList.add('hidden'); }
      },1000);
    }
    function stopRest(){ if(restTimer){ clearInterval(restTimer); restTimer = null; }}
    function finishRest(){ stopRest(); const elapsed = Math.round((Date.now()-restStartMs)/1000); currentExercise.sets[restSetIndex].restActual = elapsed; saveState(); rebuildSetsList(); restSetIndex = -1; }
    restBox.addEventListener('click', ()=>{ finishRest(); restBox.classList.add('hidden'); });

    // --- Next & Reset ---
    nextExerciseBtn.addEventListener('click', ()=>{ if(currentExercise.sets.length) pushOrMergeExercise(currentExercise); currentExercise = null; interfaceBox.classList.add('hidden'); updateSummary(); saveState(); });
    resetBtn.addEventListener('click', ()=>{ if(confirm('Reset entire workout?')){ session={exercises:[],startedAt:null}; currentExercise=null; localStorage.clear(); location.reload(); }});
    function pushOrMergeExercise(ex){ const exists = session.exercises.find(e=>e.name===ex.name); if(exists){ ex.sets.forEach(s=>exists.sets.push(JSON.parse(JSON.stringify(s)))); } else { session.exercises.push(JSON.parse(JSON.stringify(ex))); } saveState(); }

    // --- Summary ---
    function updateSummary(){ let total = 0, lines = []; session.exercises.forEach(e=>{ total+=e.sets.length; lines.push(`${e.name}: ${e.sets.length} sets`); }); if(currentExercise){ total+=currentExercise.sets.length; lines.push(`${currentExercise.name}: ${currentExercise.sets.length} sets (in progress)`); } summaryText.innerHTML = total?`<strong>Total Sets: ${total}</strong><br>${lines.join('<br>')}`:'Start your first exercise to begin tracking.'; }

    // --- Export & Save ---
    exportBtn.addEventListener('click', ()=>{/* export logic unchanged */});
    function saveState(){ localStorage.setItem('wt_session',JSON.stringify(session)); localStorage.setItem('wt_currentExercise',JSON.stringify(currentExercise)); }
  </script>
</body>
</html>
