<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Workout Tracker Pro</title>
  <meta name="description" content="Lightweight mobile workout tracker with export + AI summary">
  <style>
    /* styles omitted for brevity; use your existing CSS */
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸ’ª Workout Tracker Pro</h1>
      <div id="today" class="date"></div>
    </div>

    <div class="section">
      <!-- Custom Exercise Input -->
      <div class="inline-row" style="margin-bottom:10px;">
        <input type="text" id="customExercise" placeholder="Add Custom Exercise" class="field">
        <button id="addExercise" class="btn btn-secondary" style="flex:0 0 100px;">Add</button>
      </div>

      <!-- Exercise Select -->
      <select id="exerciseSelect">
        <option value="">Select Exercise</option>
        <option>Bench Press</option>
        <option>Incline Bench Press</option>
        <option>Squats</option>
        <option>Straight Arm Bicep Curls</option>
        <option>Lat Pulldown (Underhand)</option>
        <option>Lat Pulldown (Overhand)</option>
      </select>

      <!-- Workout Interface -->
      <div id="interface" class="hidden">
        <div class="current-exercise">
          <h2 id="exerciseName"></h2>
          <div class="set-info">Set <span id="setCounter">1</span></div>
        </div>

        <!-- Timer Controls -->
        <div class="inline-row" style="margin-bottom:10px;">
          <label class="field">
            <input type="checkbox" id="useTimer" checked> Use Timer
          </label>
          <input type="number" id="restSecsInput" class="field" placeholder="Rest (sec)" value="90" min="5">
        </div>

        <!-- Rest Timer Display -->
        <div id="restBox" class="rest-timer hidden">
          <div>Rest Time</div>
          <div id="restDisplay" class="timer-display">01:30</div>
          <small>Tap to cancel</small>
        </div>

        <!-- Inputs for Weight & Reps -->
        <div class="inline-row">
          <input type="number" id="weight" class="field" placeholder="Weight (lbs)">
          <input type="number" id="reps" class="field" placeholder="Reps">
        </div>

        <!-- Action Buttons -->
        <button id="logBtn" class="btn btn-primary">Log Set</button>
        <button id="nextExerciseBtn" class="btn btn-secondary">Next Exercise</button>
        <button id="resetBtn" class="btn btn-reset">Reset Workout</button>
      </div>

      <!-- Sets History -->
      <div class="sets-history">
        <h3>Today's Sets</h3>
        <div id="setsList"></div>
      </div>

      <!-- Summary & Export -->
      <div class="summary">
        <h3>Workout Summary</h3>
        <div id="summaryText">Start your first exercise to begin tracking.</div>
      </div>
      <button id="exportBtn" class="btn btn-export">Export (JSON + CSV + AI)</button>
    </div>
  </div>

  <!-- Dark Mode Toggle -->
  <button id="darkToggle" aria-label="Toggle dark mode" class="dark-toggle">ðŸŒ“</button>

  <script>
    // State
    let session = JSON.parse(localStorage.getItem('wt_session')) || { exercises: [], startedAt: null };
    let currentExercise = JSON.parse(localStorage.getItem('wt_currentExercise')) || null;
    let restTimer = null, restStartMs = 0, restSetIndex = -1;

    // Elements
    const todayEl = document.getElementById('today');
    const addExerciseBtn = document.getElementById('addExercise');
    const customExerciseInput = document.getElementById('customExercise');
    const exerciseSelect = document.getElementById('exerciseSelect');
    const interfaceBox = document.getElementById('interface');
    const exerciseNameEl = document.getElementById('exerciseName');
    const setCounterEl = document.getElementById('setCounter');
    const useTimerEl = document.getElementById('useTimer');
    const restSecsInput = document.getElementById('restSecsInput');
    const restBox = document.getElementById('restBox');
    const restDisplay = document.getElementById('restDisplay');
    const weightInput = document.getElementById('weight');
    const repsInput = document.getElementById('reps');
    const logBtn = document.getElementById('logBtn');
    const nextExerciseBtn = document.getElementById('nextExerciseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const setsList = document.getElementById('setsList');
    const summaryText = document.getElementById('summaryText');
    const exportBtn = document.getElementById('exportBtn');
    const darkToggle = document.getElementById('darkToggle');

    // Initialize
    todayEl.textContent = new Date().toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    if (currentExercise) { showInterface(); rebuildSetsList(); updateSetCounter(); }
    updateSummary();
    if (localStorage.getItem('wt_theme') === 'dark') document.body.classList.add('dark');

    // Dark Mode Toggle
    darkToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      localStorage.setItem('wt_theme', document.body.classList.contains('dark') ? 'dark' : 'light');
    });

    // Add Custom Exercise
    addExerciseBtn.addEventListener('click', () => {
      const name = customExerciseInput.value.trim();
      if (!name) return;
      const opt = document.createElement('option'); opt.textContent = name;
      exerciseSelect.appendChild(opt);
      exerciseSelect.value = name;
      customExerciseInput.value = '';
      startExercise(name);
    });

    // Select Exercise
    exerciseSelect.addEventListener('change', e => {
      if (e.target.value) startExercise(e.target.value);
    });
    function startExercise(name) {
      if (!session.startedAt) session.startedAt = new Date().toISOString();
      if (currentExercise && currentExercise.sets.length) pushOrMergeExercise(currentExercise);
      currentExercise = { name, sets: [], nextSet: 1 };
      saveState();
      showInterface(); rebuildSetsList(); updateSetCounter();
      weightInput.focus();
    }
    function showInterface() {
      interfaceBox.classList.remove('hidden');
      exerciseNameEl.textContent = currentExercise.name;
    }

    // Log Set
    logBtn.addEventListener('click', () => {
      const w = parseInt(weightInput.value, 10);
      const r = parseInt(repsInput.value, 10);
      if (!w || !r) { alert('Enter weight & reps'); return; }
      const useT = useTimerEl.checked;
      const planned = parseInt(restSecsInput.value, 10) || 0;
      const setObj = { set: currentExercise.nextSet, weight: w, reps: r,
                       time: new Date().toLocaleTimeString(), restPlanned: useT ? planned : null, restActual: null };
      currentExercise.sets.push(setObj);
      addSetElement(setObj, currentExercise.sets.length - 1);
      currentExercise.nextSet++;
      updateSetCounter();
      weightInput.select(); repsInput.value = '';
      if (useT) startRest(planned, currentExercise.sets.length - 1);
      updateSummary(); saveState();
    });
    function addSetElement(s, idx) {
      const item = document.createElement('div'); item.className = 'set-item'; item.dataset.index = idx;
      const restInfo = s.restActual !== null
        ? ` â€¢ Rest: ${s.restActual}s`
        : (s.restPlanned !== null ? ` â€¢ Rest planned: ${s.restPlanned}s` : '');
      item.innerHTML = `
        <div>
          <div class="set-label">Set ${s.set}: ${s.weight}Ã—${s.reps}</div>
          <div class="set-meta">${s.time}${restInfo}</div>
        </div>
        <div class="set-actions">
          <button class="btn-mini edit" data-action="edit">Edit</button>
          <button class="btn-mini del" data-action="del">Del</button>
        </div>`;
      setsList.appendChild(item);
    }

    // Edit/Delete Sets
    setsList.addEventListener('click', e => {
